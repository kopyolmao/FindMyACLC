<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FindMyACLC - Lost & Found</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f8f9fa;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: #2c3e50;
            color: white;
            padding: 1rem 0;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .header .container {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 1.8rem;
            font-weight: bold;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }

        .btn-primary {
            background: #3498db;
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-secondary {
            background: #95a5a6;
            color: white;
        }

        .btn-secondary:hover {
            background: #7f8c8d;
        }

        .btn-outline {
            background: transparent;
            border: 2px solid #3498db;
            color: #3498db;
        }

        .btn-outline:hover {
            background: #3498db;
            color: white;
        }

        /* Main Content */
        .main {
            padding: 2rem 0;
        }

        .hero {
            text-align: center;
            padding: 3rem 0;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 10px;
            margin-bottom: 2rem;
        }

        .hero h2 {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .hero p {
            font-size: 1.2rem;
            margin-bottom: 2rem;
            opacity: 0.9;
        }

        .hero-actions {
            display: flex;
            gap: 1rem;
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Search Section */
        .search-section {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 2rem;
        }

        .search-box {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .search-box input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        .filters {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .filters select, .filters input {
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        /* Items Grid */
        .items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .item-card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
            transition: transform 0.3s ease;
        }

        .item-card:hover {
            transform: translateY(-5px);
        }

        .item-image {
            width: 100%;
            height: 200px;
            background: #f8f9fa;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }

        .item-content {
            padding: 1.5rem;
        }

        .item-title {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
            color: #2c3e50;
        }

        .item-meta {
            display: flex;
            gap: 1rem;
            font-size: 0.9rem;
            color: #6c757d;
            margin-bottom: 1rem;
        }

        .item-description {
            color: #555;
            margin-bottom: 1rem;
        }

        .claim-btn {
            width: 100%;
        }

        /* Pagination */
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 1rem;
            margin-top: 2rem;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 2rem;
            border-radius: 10px;
            width: 90%;
            max-width: 500px;
            position: relative;
        }

        .close {
            position: absolute;
            right: 1rem;
            top: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #999;
        }

        .close:hover {
            color: #333;
        }

        form input, form textarea, form select {
            width: 100%;
            padding: 12px;
            margin-bottom: 1rem;
            border: 2px solid #ddd;
            border-radius: 5px;
            font-size: 16px;
        }

        form textarea {
            height: 100px;
            resize: vertical;
        }

        .confidential-qa {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
        }

        .confidential-qa h4 {
            margin-bottom: 1rem;
            color: #2c3e50;
        }

        /* Chat Bot */
        .chat-bubble {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 60px;
            height: 60px;
            background: #3498db;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.3);
            transition: all 0.3s ease;
            opacity: 1;
            transform: scale(1);
            font-size: 1.5rem;
            z-index: 1001;
        }

        .chat-bubble.hidden {
            opacity: 0;
            transform: scale(0);
            pointer-events: none;
        }

        .chat-window {
            position: fixed;
            bottom: 90px;
            right: 25px;
            width: 350px;
            height: 500px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            display: none;
            flex-direction: column;
            opacity: 0;
            transform: translateY(20px);
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            z-index: 1001;
        }

        .chat-window.open {
            opacity: 1;
            display: flex;
            transform: translateY(0);
        }

        .chat-window.minimized {
            height: 40px;
            overflow: hidden;
        }

        .chat-header {
            background: #3498db;
            color: white;
            padding: 12px;
            border-radius: 12px 12px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            cursor: pointer;
        }

        .chat-header h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 600;
        }

        .chat-header button {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .chat-header button:hover {
            transform: scale(1.1);
        }

        .chat-messages {
            flex: 1;
            padding: 12px;
            overflow-y: auto;
            background: #f9f9f9;
            transition: opacity 0.3s ease;
        }

        .chat-window.minimized .chat-messages {
            opacity: 0;
        }

        .chat-input {
            display: flex;
            padding: 12px;
            border-top: 1px solid #eee;
            background: #fff;
            transition: opacity 0.3s ease;
        }

        .chat-window.minimized .chat-input {
            opacity: 0;
        }

        #chatInput {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            transition: border-color 0.3s ease;
            font-size: 14px;
        }

        #chatInput:focus {
            border-color: #3498db;
            outline: none;
        }

        #sendChat {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            margin-left: 8px;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        #sendChat:hover {
            background: #2980b9;
        }

        .message {
            padding: 12px 16px;
            margin: 10px 0;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
            font-size: 14px;
            line-height: 1.4;
            position: relative;
        }

        .message.user {
            background: #3498db;
            color: white;
            margin-left: auto;
            border-bottom-right-radius: 4px;
            margin-right: 10px;
            border: 2px solid #3498db;
        }

        .message.ai {
            background: #e0e0e0;
            color: #333;
            margin-right: auto;
            border-bottom-left-radius: 4px;
            margin-left: 10px;
            border: 2px solid #e0e0e0;
        }

        .message.user::after {
            content: '';
            position: absolute;
            right: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-left: 10px solid #3498db;
        }

        .message.ai::before {
            content: '';
            position: absolute;
            left: -10px;
            top: 12px;
            width: 0;
            height: 0;
            border-top: 8px solid transparent;
            border-bottom: 8px solid transparent;
            border-right: 10px solid #e0e0e0;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            margin: 8px 0;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .typing-indicator.visible {
            opacity: 1;
        }

        .typing-indicator span {
            display: inline-block;
            width: 6px;
            height: 6px;
            background: #3498db;
            border-radius: 50%;
            margin: 0 2px;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-6px); }
        }

        .chat-messages::-webkit-scrollbar {
            width: 8px;
        }

        .chat-messages::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .chat-messages::-webkit-scrollbar-thumb:hover {
            background: #666;
        }

        .chat-messages {
            scrollbar-width: thin;
            scrollbar-color: #888 #f1f1f1;
        }

        /* Toast */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background-color: #333;
            color: #fff;
            padding: 10px;
            border-radius: 5px;
            z-index: 1000;
        }

        /* Dashboard */
        .dashboard {
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-actions {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .hero-actions {
                flex-direction: column;
                align-items: center;
            }
            
            .search-box {
                flex-direction: column;
            }
            
            .filters {
                flex-direction: column;
            }
            
            .items-grid {
                grid-template-columns: 1fr;
            }
            
            .chat-window {
                width: 90%;
                right: 5%;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="container">
            <h1 class="logo">FindMyACLC</h1>
            <nav class="nav">
                <button id="loginBtn" class="btn btn-outline">Login</button>
                <button id="registerBtn" class="btn btn-primary">Register</button>
                <button id="dashboardBtn" class="btn btn-outline" style="display: none;">Dashboard</button>
                <button id="logoutBtn" class="btn btn-outline" style="display: none;">Logout</button>
            </nav>
        </div>
    </header>

    <!-- Main Content -->
    <main class="main">
        <div class="container">
            <!-- Hero Section -->
            <section class="hero">
                <h2>Find Your Lost Items</h2>
                <p>Lost something on campus? Check our found items database or report a found item.</p>
                <div class="hero-actions">
                    <button id="browseItems" class="btn btn-primary">Browse Found Items</button>
                    <button id="reportFound" class="btn btn-secondary">Report Found Item</button>
                    <button id="reportLost" class="btn btn-outline" style="display: none;">Report Lost Item</button>
                </div>
            </section>

            <!-- Search Section -->
            <section class="search-section">
                <div class="search-box">
                    <input type="text" id="searchInput" placeholder="Search for items (e.g., 'black water bottle', 'phone')">
                    <button id="searchBtn" class="btn btn-primary">Search</button>
                </div>
                <div class="filters">
                    <select id="categoryFilter">
                        <option value="">All Categories</option>
                        <option value="electronics">Electronics</option>
                        <option value="clothing">Clothing</option>
                        <option value="books">Books</option>
                        <option value="accessories">Accessories</option>
                        <option value="other">Other</option>
                    </select>
                    <input type="date" id="dateFilter">
                    <input type="text" id="locationFilter" placeholder="Location">
                </div>
            </section>

            <!-- Items Grid -->
            <section class="items-section">
                <h3>Recently Found Items</h3>
                <div id="itemsGrid" class="items-grid">
                    <!-- Items will be loaded here -->
                </div>
                <div class="pagination">
                    <button id="prevPage" class="btn btn-outline">Previous</button>
                    <span id="pageInfo">Page 1</span>
                    <button id="nextPage" class="btn btn-outline">Next</button>
                </div>
            </section>
        </div>
    </main>

    <!-- Dashboard (Hidden by default) -->
    <section class="dashboard container" id="dashboardSection">
        <div class="dashboard-header">
            <h2>Dashboard</h2>
            <button id="backToMain" class="btn btn-outline">Back to Main</button>
        </div>
        <div class="dashboard-actions">
            <button id="myItemsBtn" class="btn btn-primary">My Items</button>
            <button id="myClaimsBtn" class="btn btn-primary">My Claims</button>
            <button id="adminPanelBtn" class="btn btn-secondary" style="display: none;">Admin Panel</button>
        </div>
        <div id="dashboardContent">
            <!-- Dashboard content will be loaded here -->
        </div>
    </section>

    <!-- Auth Modal -->
    <div id="authModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3 id="modalTitle">Login</h3>
            <form id="authForm">
                <input type="email" id="authEmail" placeholder="Email" required>
                <input type="password" id="authPassword" placeholder="Password" required>
                <input type="text" id="authId" placeholder="Student/Staff ID" style="display: none;">
                <button type="submit" class="btn btn-primary">Submit</button>
            </form>
            <p id="authSwitch">Don't have an account? <a href="#" id="switchToRegister">Register</a></p>
        </div>
    </div>

    <!-- Report Modal -->
    <div id="reportModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Report Found Item</h3>
            <form id="reportForm">
                <input type="text" id="itemTitle" placeholder="Item Title" required>
                <textarea id="itemDescription" placeholder="Description" required></textarea>
                <input type="text" id="itemLocation" placeholder="Location Found" required>
                <select id="itemCategory" required>
                    <option value="">Select Category</option>
                    <option value="electronics">Electronics</option>
                    <option value="clothing">Clothing</option>
                    <option value="books">Books</option>
                    <option value="accessories">Accessories</option>
                    <option value="other">Other</option>
                </select>
                <input type="file" id="itemImage" accept="image/*">
                <div class="confidential-qa">
                    <h4>Security Questions (for verification)</h4>
                    <input type="text" id="question1" placeholder="Question 1" required>
                    <input type="text" id="answer1" placeholder="Answer 1" required>
                    <input type="text" id="question2" placeholder="Question 2" required>
                    <input type="text" id="answer2" placeholder="Answer 2" required>
                </div>
                <button type="submit" class="btn btn-primary">Submit Report</button>
            </form>
        </div>
    </div>

    <!-- Claim Modal -->
    <div id="claimModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h3>Claim Item</h3>
            <div id="claimQuestions">
                <!-- Questions will be loaded here -->
            </div>
            <button id="submitClaim" class="btn btn-primary" style="display: none;">Submit Answers</button>
        </div>
    </div>

    <!-- Chat Bot -->
    <div class="chat-bubble" id="chatBubble">ðŸ’¬</div>
    <div class="chat-window" id="chatWindow">
        <div class="chat-header">
            <h3>FindMyACLC Assistant</h3>
            <button id="minimizeChat">âˆ’</button>
        </div>
        <div class="chat-messages" id="chatMessages">
            <div class="message ai">
                Hello! I'm your FindMyACLC assistant. I can help you search for lost items, answer questions about our service, and guide you through the claiming process. How can I help you today?
            </div>
        </div>
        <div class="chat-input">
            <input type="text" id="chatInput" placeholder="Ask about lost items...">
            <button id="sendChat">âž¤</button>
        </div>
    </div>

    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBASqZ7VDxU_j6VEDN9pmhIDuDM1SU9qoI",
            authDomain: "findmyaclc.firebaseapp.com",
            projectId: "findmyaclc",
            storageBucket: "findmyaclc.firebasestorage.app",
            messagingSenderId: "351280538849",
            appId: "1:351280538849:web:7b930e2e2885b40f4083a0",
            measurementId: "G-ZH9V9KH3H2"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const storage = firebase.storage();

        // Global variables
        let currentUser = null;
        let currentItems = [];
        let currentPage = 1;
        const itemsPerPage = 6;
        let selectedItemForClaim = null;

        // DOM Elements
        const loginBtn = document.getElementById('loginBtn');
        const registerBtn = document.getElementById('registerBtn');
        const dashboardBtn = document.getElementById('dashboardBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const authModal = document.getElementById('authModal');
        const reportModal = document.getElementById('reportModal');
        const claimModal = document.getElementById('claimModal');
        const modalTitle = document.getElementById('modalTitle');
        const authForm = document.getElementById('authForm');
        const authSwitch = document.getElementById('authSwitch');
        const switchToRegister = document.getElementById('switchToRegister');
        const authId = document.getElementById('authId');
        const browseItemsBtn = document.getElementById('browseItems');
        const reportFoundBtn = document.getElementById('reportFound');
        const reportLostBtn = document.getElementById('reportLost');
        const searchBtn = document.getElementById('searchBtn');
        const searchInput = document.getElementById('searchInput');
        const categoryFilter = document.getElementById('categoryFilter');
        const dateFilter = document.getElementById('dateFilter');
        const locationFilter = document.getElementById('locationFilter');
        const itemsGrid = document.getElementById('itemsGrid');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfo = document.getElementById('pageInfo');
        const reportForm = document.getElementById('reportForm');
        const dashboardSection = document.getElementById('dashboardSection');
        const backToMainBtn = document.getElementById('backToMain');
        const myItemsBtn = document.getElementById('myItemsBtn');
        const myClaimsBtn = document.getElementById('myClaimsBtn');
        const adminPanelBtn = document.getElementById('adminPanelBtn');
        const dashboardContent = document.getElementById('dashboardContent');

        // Chat elements
        const chatBubble = document.getElementById('chatBubble');
        const chatWindow = document.getElementById('chatWindow');
        const chatInput = document.getElementById('chatInput');
        const sendChat = document.getElementById('sendChat');
        const minimizeChat = document.getElementById('minimizeChat');
        const chatMessages = document.getElementById('chatMessages');

        // Event Listeners
        document.addEventListener('DOMContentLoaded', initApp);
        loginBtn.addEventListener('click', () => openAuthModal('login'));
        registerBtn.addEventListener('click', () => openAuthModal('register'));
        logoutBtn.addEventListener('click', handleLogout);
        dashboardBtn.addEventListener('click', showDashboard);
        backToMainBtn.addEventListener('click', showMain);
        browseItemsBtn.addEventListener('click', loadItems);
        reportFoundBtn.addEventListener('click', openReportModal);
        reportLostBtn.addEventListener('click', openReportModal);
        searchBtn.addEventListener('click', handleSearch);
        searchInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSearch();
        });
        prevPageBtn.addEventListener('click', () => changePage(-1));
        nextPageBtn.addEventListener('click', () => changePage(1));
        reportForm.addEventListener('submit', handleReportSubmit);
        myItemsBtn.addEventListener('click', () => loadMyItems());
        myClaimsBtn.addEventListener('click', () => loadMyClaims());
        adminPanelBtn.addEventListener('click', () => loadAdminPanel());

        // Chat event listeners
        chatBubble.addEventListener('click', toggleChat);
        minimizeChat.addEventListener('click', toggleMinimize);
        sendChat.addEventListener('click', handleSendChat);
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') handleSendChat();
        });

        // Modal close buttons
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', () => {
                authModal.style.display = 'none';
                reportModal.style.display = 'none';
                claimModal.style.display = 'none';
            });
        });

        // Close modals when clicking outside
        window.addEventListener('click', (e) => {
            if (e.target === authModal) authModal.style.display = 'none';
            if (e.target === reportModal) reportModal.style.display = 'none';
            if (e.target === claimModal) claimModal.style.display = 'none';
        });

        // Initialize the application
        function initApp() {
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    updateUIForUser(user);
                    loadItems();
                } else {
                    currentUser = null;
                    updateUIForGuest();
                    loadItems();
                }
            });

            // Load initial items
            loadItems();
        }

        // Update UI for logged in user
        function updateUIForUser(user) {
            loginBtn.style.display = 'none';
            registerBtn.style.display = 'none';
            dashboardBtn.style.display = 'block';
            logoutBtn.style.display = 'block';
            reportFoundBtn.style.display = 'block';
            
            // Check if user is staff/admin (simplified logic)
            db.collection('users').doc(user.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.role === 'staff' || userData.role === 'admin') {
                            reportLostBtn.style.display = 'block';
                            adminPanelBtn.style.display = 'block';
                        }
                    }
                });
        }

        // Update UI for guest
        function updateUIForGuest() {
            loginBtn.style.display = 'block';
            registerBtn.style.display = 'block';
            dashboardBtn.style.display = 'none';
            logoutBtn.style.display = 'none';
            reportFoundBtn.style.display = 'none';
            reportLostBtn.style.display = 'none';
            adminPanelBtn.style.display = 'none';
        }

        // Open auth modal
        function openAuthModal(type) {
            authModal.style.display = 'block';
            if (type === 'login') {
                modalTitle.textContent = 'Login';
                authId.style.display = 'none';
                authSwitch.innerHTML = 'Don\'t have an account? <a href="#" id="switchToRegister">Register</a>';
                document.getElementById('switchToRegister').addEventListener('click', (e) => {
                    e.preventDefault();
                    openAuthModal('register');
                });
            } else {
                modalTitle.textContent = 'Register';
                authId.style.display = 'block';
                authSwitch.innerHTML = 'Already have an account? <a href="#" id="switchToLogin">Login</a>';
                document.getElementById('switchToLogin').addEventListener('click', (e) => {
                    e.preventDefault();
                    openAuthModal('login');
                });
            }
        }

        // Handle auth form submission
        authForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('authEmail').value;
            const password = document.getElementById('authPassword').value;
            const id = document.getElementById('authId').value;

            if (modalTitle.textContent === 'Login') {
                // Login
                auth.signInWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        authModal.style.display = 'none';
                        showToast('Login successful!');
                    })
                    .catch((error) => {
                        showToast('Login failed: ' + error.message);
                    });
            } else {
                // Register
                auth.createUserWithEmailAndPassword(email, password)
                    .then((userCredential) => {
                        const user = userCredential.user;
                        // Save user data to Firestore
                        return db.collection('users').doc(user.uid).set({
                            email: email,
                            id: id,
                            role: 'student', // Default role
                            createdAt: firebase.firestore.FieldValue.serverTimestamp()
                        });
                    })
                    .then(() => {
                        authModal.style.display = 'none';
                        showToast('Registration successful!');
                    })
                    .catch((error) => {
                        showToast('Registration failed: ' + error.message);
                    });
            }
        });

        // Handle logout
        function handleLogout() {
            auth.signOut()
                .then(() => {
                    showToast('Logged out successfully');
                    showMain();
                })
                .catch((error) => {
                    showToast('Logout failed: ' + error.message);
                });
        }

        // Show main page
        function showMain() {
            document.querySelector('.main').style.display = 'block';
            dashboardSection.style.display = 'none';
        }

        // Show dashboard
        function showDashboard() {
            document.querySelector('.main').style.display = 'none';
            dashboardSection.style.display = 'block';
            loadMyItems(); // Default dashboard view
        }

        // Load items from Firestore
        function loadItems() {
            let query = db.collection('foundItems')
                .where('isClaimed', '==', false)
                .orderBy('dateFound', 'desc')
                .limit(itemsPerPage);

            // Apply filters if provided
            const category = categoryFilter.value;
            const date = dateFilter.value;
            const location = locationFilter.value.toLowerCase();

            if (category) {
                query = query.where('category', '==', category);
            }

            if (date) {
                query = query.where('dateFound', '==', date);
            }

            query.get()
                .then((querySnapshot) => {
                    currentItems = [];
                    itemsGrid.innerHTML = '';

                    if (querySnapshot.empty) {
                        itemsGrid.innerHTML = '<p>No items found.</p>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const item = { id: doc.id, ...doc.data() };
                        currentItems.push(item);
                        
                        // Apply location filter client-side if needed
                        if (location && !item.location.toLowerCase().includes(location)) {
                            return;
                        }

                        displayItem(item);
                    });

                    updatePagination();
                })
                .catch((error) => {
                    console.error('Error loading items:', error);
                    itemsGrid.innerHTML = '<p>Error loading items. Please try again.</p>';
                });
        }

        // Display an item in the grid
        function displayItem(item) {
            const itemCard = document.createElement('div');
            itemCard.className = 'item-card';
            
            const date = item.dateFound ? new Date(item.dateFound.seconds * 1000).toLocaleDateString() : 'Unknown date';
            
            itemCard.innerHTML = `
                <div class="item-image">
                    ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title}" style="width:100%;height:100%;object-fit:cover;">` : 'No Image'}
                </div>
                <div class="item-content">
                    <h3 class="item-title">${item.title}</h3>
                    <div class="item-meta">
                        <span>${item.category}</span>
                        <span>${date}</span>
                    </div>
                    <p class="item-description">${item.description}</p>
                    <p><strong>Location:</strong> ${item.location}</p>
                    <button class="btn btn-primary claim-btn" data-id="${item.id}">Claim This Item</button>
                </div>
            `;
            
            itemsGrid.appendChild(itemCard);
            
            // Add event listener to claim button
            itemCard.querySelector('.claim-btn').addEventListener('click', () => {
                if (!currentUser) {
                    showToast('Please login to claim items');
                    openAuthModal('login');
                    return;
                }
                openClaimModal(item);
            });
        }

        // Handle search
        function handleSearch() {
            currentPage = 1;
            loadItems();
        }

        // Change page
        function changePage(direction) {
            currentPage += direction;
            if (currentPage < 1) currentPage = 1;
            loadItems();
        }

        // Update pagination info
        function updatePagination() {
            pageInfo.textContent = `Page ${currentPage}`;
            prevPageBtn.disabled = currentPage === 1;
            // Note: In a real app, you'd check if there are more items
        }

        // Open report modal
        function openReportModal() {
            if (!currentUser) {
                showToast('Please login to report items');
                openAuthModal('login');
                return;
            }
            reportModal.style.display = 'block';
        }

        // Handle report submission
        function handleReportSubmit(e) {
            e.preventDefault();
            
            if (!currentUser) {
                showToast('Please login to report items');
                return;
            }
            
            const title = document.getElementById('itemTitle').value;
            const description = document.getElementById('itemDescription').value;
            const location = document.getElementById('itemLocation').value;
            const category = document.getElementById('itemCategory').value;
            const question1 = document.getElementById('question1').value;
            const answer1 = document.getElementById('answer1').value;
            const question2 = document.getElementById('question2').value;
            const answer2 = document.getElementById('answer2').value;
            const imageFile = document.getElementById('itemImage').files[0];
            
            // Prepare item data
            const itemData = {
                title,
                description,
                location,
                category,
                confidentialQuestions: [
                    { question: question1, answer: answer1 },
                    { question: question2, answer: answer2 }
                ],
                postedBy: currentUser.uid,
                dateFound: new Date().toISOString().split('T')[0],
                isClaimed: false,
                createdAt: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Upload image if provided
            if (imageFile) {
                const storageRef = storage.ref();
                const imageRef = storageRef.child(`items/${Date.now()}_${imageFile.name}`);
                
                imageRef.put(imageFile)
                    .then(snapshot => snapshot.ref.getDownloadURL())
                    .then(url => {
                        itemData.imageUrl = url;
                        saveItemToFirestore(itemData);
                    })
                    .catch(error => {
                        console.error('Error uploading image:', error);
                        saveItemToFirestore(itemData);
                    });
            } else {
                saveItemToFirestore(itemData);
            }
        }

        // Save item to Firestore
        function saveItemToFirestore(itemData) {
            db.collection('foundItems').add(itemData)
                .then(() => {
                    reportModal.style.display = 'none';
                    reportForm.reset();
                    showToast('Item reported successfully!');
                    loadItems();
                })
                .catch(error => {
                    console.error('Error saving item:', error);
                    showToast('Error reporting item: ' + error.message);
                });
        }

        // Open claim modal
        function openClaimModal(item) {
            selectedItemForClaim = item;
            claimModal.style.display = 'block';
            
            const claimQuestions = document.getElementById('claimQuestions');
            claimQuestions.innerHTML = '';
            
            // Display questions for the user to answer
            item.confidentialQuestions.forEach((q, index) => {
                const questionDiv = document.createElement('div');
                questionDiv.innerHTML = `
                    <p><strong>Question ${index + 1}:</strong> ${q.question}</p>
                    <input type="text" id="answer${index}" placeholder="Your answer" class="claim-answer">
                `;
                claimQuestions.appendChild(questionDiv);
            });
            
            document.getElementById('submitClaim').style.display = 'block';
            document.getElementById('submitClaim').onclick = handleClaimSubmit;
        }

        // Handle claim submission
        function handleClaimSubmit() {
            if (!selectedItemForClaim || !currentUser) return;
            
            const answers = [];
            let allAnswered = true;
            
            selectedItemForClaim.confidentialQuestions.forEach((_, index) => {
                const answer = document.getElementById(`answer${index}`).value.trim();
                if (answer) {
                    answers.push(answer);
                } else {
                    allAnswered = false;
                }
            });
            
            if (!allAnswered) {
                showToast('Please answer all questions');
                return;
            }
            
            // In a real implementation, you would verify answers here
            // For this demo, we'll just record the attempt
            
            // Record claim attempt
            const claimData = {
                userId: currentUser.uid,
                itemId: selectedItemForClaim.id,
                answers: answers,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            db.collection('claimAttempts').add(claimData)
                .then(() => {
                    claimModal.style.display = 'none';
                    showToast('Claim submitted. You will be contacted if your claim is verified.');
                    
                    // In a real app, you would check answers and update item status
                    // For demo purposes, we'll just close the modal
                })
                .catch(error => {
                    console.error('Error submitting claim:', error);
                    showToast('Error submitting claim: ' + error.message);
                });
        }

        // Load user's items
        function loadMyItems() {
            if (!currentUser) return;
            
            dashboardContent.innerHTML = '<h3>My Reported Items</h3>';
            
            db.collection('foundItems')
                .where('postedBy', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        dashboardContent.innerHTML += '<p>You haven\'t reported any items yet.</p>';
                        return;
                    }
                    
                    const itemsList = document.createElement('div');
                    itemsList.className = 'items-grid';
                    
                    querySnapshot.forEach(doc => {
                        const item = { id: doc.id, ...doc.data() };
                        const itemCard = document.createElement('div');
                        itemCard.className = 'item-card';
                        
                        const date = item.dateFound ? new Date(item.dateFound.seconds * 1000).toLocaleDateString() : 'Unknown date';
                        const status = item.isClaimed ? 'Claimed' : 'Not Claimed';
                        
                        itemCard.innerHTML = `
                            <div class="item-image">
                                ${item.imageUrl ? `<img src="${item.imageUrl}" alt="${item.title}" style="width:100%;height:100%;object-fit:cover;">` : 'No Image'}
                            </div>
                            <div class="item-content">
                                <h3 class="item-title">${item.title}</h3>
                                <div class="item-meta">
                                    <span>${item.category}</span>
                                    <span>${date}</span>
                                </div>
                                <p class="item-description">${item.description}</p>
                                <p><strong>Location:</strong> ${item.location}</p>
                                <p><strong>Status:</strong> ${status}</p>
                            </div>
                        `;
                        
                        itemsList.appendChild(itemCard);
                    });
                    
                    dashboardContent.appendChild(itemsList);
                })
                .catch(error => {
                    console.error('Error loading user items:', error);
                    dashboardContent.innerHTML += '<p>Error loading your items.</p>';
                });
        }

        // Load user's claims
        function loadMyClaims() {
            if (!currentUser) return;
            
            dashboardContent.innerHTML = '<h3>My Claim Attempts</h3>';
            
            db.collection('claimAttempts')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .get()
                .then(querySnapshot => {
                    if (querySnapshot.empty) {
                        dashboardContent.innerHTML += '<p>You haven\'t made any claims yet.</p>';
                        return;
                    }
                    
                    const claimsList = document.createElement('div');
                    
                    querySnapshot.forEach(doc => {
                        const claim = { id: doc.id, ...doc.data() };
                        const claimItem = document.createElement('div');
                        claimItem.className = 'item-card';
                        claimItem.style.marginBottom = '1rem';
                        
                        const date = claim.timestamp ? new Date(claim.timestamp.seconds * 1000).toLocaleDateString() : 'Unknown date';
                        
                        claimItem.innerHTML = `
                            <div class="item-content">
                                <h4>Claim for Item ID: ${claim.itemId}</h4>
                                <p><strong>Submitted:</strong> ${date}</p>
                                <p><strong>Status:</strong> Pending Verification</p>
                            </div>
                        `;
                        
                        claimsList.appendChild(claimItem);
                    });
                    
                    dashboardContent.appendChild(claimsList);
                })
                .catch(error => {
                    console.error('Error loading user claims:', error);
                    dashboardContent.innerHTML += '<p>Error loading your claims.</p>';
                });
        }

        // Load admin panel
        function loadAdminPanel() {
            if (!currentUser) return;
            
            dashboardContent.innerHTML = '<h3>Admin Panel</h3><p>Admin features would be implemented here.</p>';
            
            // Check if user is actually admin/staff
            db.collection('users').doc(currentUser.uid).get()
                .then(doc => {
                    if (doc.exists) {
                        const userData = doc.data();
                        if (userData.role === 'staff' || userData.role === 'admin') {
                            // Load admin-specific content
                            loadAdminContent();
                        } else {
                            dashboardContent.innerHTML = '<p>Access denied. Admin privileges required.</p>';
                        }
                    }
                });
        }

        // Load admin-specific content
        function loadAdminContent() {
            // In a real implementation, this would load admin-specific features
            dashboardContent.innerHTML += `
                <div class="admin-actions">
                    <button class="btn btn-primary" onclick="loadPendingItems()">Review Pending Items</button>
                    <button class="btn btn-primary" onclick="loadClaimVerifications()">Verify Claims</button>
                    <button class="btn btn-primary" onclick="loadUserManagement()">Manage Users</button>
                </div>
                <div id="adminContent"></div>
            `;
        }

        // Chat functionality
        class ChatInterface {
            constructor() {
                this.isOpen = false;
                this.isMinimized = false;
                this.isTyping = false;
                this.rateLimit = { lastRequest: 0, delay: 1000 };
            }

            toggleChat() {
                this.isOpen = !this.isOpen;
                if (this.isOpen) {
                    chatWindow.classList.add('open');
                    chatBubble.classList.add('hidden');
                    setTimeout(() => chatInput.focus(), 100);
                } else {
                    chatWindow.classList.remove('open');
                    chatBubble.classList.remove('hidden');
                }
            }

            toggleMinimize() {
                this.isMinimized = !this.isMinimized;
                chatWindow.classList.toggle('minimized', this.isMinimized);
                minimizeChat.textContent = this.isMinimized ? '+' : 'âˆ’';
            }

            handleSend() {
                const message = chatInput.value.trim();
                if (!message) return;
                if (this.isRateLimited()) {
                    this.displayMessage("Assistant: Please wait a moment before sending another message.", "ai");
                    return;
                }
                this.displayMessage("You: " + this.sanitizeInput(message), "user");
                chatInput.value = '';
                this.rateLimit.lastRequest = Date.now();
                this.showTypingIndicator();
                this.handleQuery(message);
            }

            isRateLimited() {
                return Date.now() - this.rateLimit.lastRequest < this.rateLimit.delay;
            }

            sanitizeInput(input) {
                const div = document.createElement('div');
                div.textContent = input;
                return div.innerHTML;
            }

            handleQuery(query) {
                // In a real implementation, this would send to your Cloudflare Worker
                // For now, we'll simulate a response
                setTimeout(() => {
                    this.hideTypingIndicator();
                    let response = "I'm here to help you with lost and found items. ";
                    
                    if (query.toLowerCase().includes('lost') || query.toLowerCase().includes('find')) {
                        response += "You can browse the found items above or use the search filters to narrow down results. ";
                        response += "If you don't see your item, you might want to check back later or report it as lost if you have staff privileges.";
                    } else if (query.toLowerCase().includes('claim')) {
                        response += "To claim an item, click the 'Claim This Item' button on any found item. ";
                        response += "You'll need to answer security questions to verify you're the rightful owner.";
                    } else if (query.toLowerCase().includes('report')) {
                        response += "To report a found item, click the 'Report Found Item' button. ";
                        response += "You'll need to provide details about the item and set up security questions for verification.";
                    } else {
                        response += "I can help you search for lost items, understand the claiming process, or guide you through reporting found items. What would you like to know?";
                    }
                    
                    this.displayMessage("Assistant: " + response, "ai");
                }, 1000);
            }

            displayMessage(text, type) {
                const messageElem = document.createElement('div');
                messageElem.classList.add('message', type);
                messageElem.textContent = text;
                messageElem.setAttribute('aria-live', 'polite');
                chatMessages.appendChild(messageElem);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            showTypingIndicator() {
                const typingElem = document.createElement('div');
                typingElem.classList.add('typing-indicator', 'visible');
                typingElem.innerHTML = `
                    <span></span>
                    <span></span>
                    <span></span>
                `;
                chatMessages.appendChild(typingElem);
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }

            hideTypingIndicator() {
                const typingElem = chatMessages.querySelector('.typing-indicator');
                if (typingElem) {
                    typingElem.remove();
                }
            }
        }

        // Initialize chat
        const chatInterface = new ChatInterface();

        function toggleChat() {
            chatInterface.toggleChat();
        }

        function toggleMinimize() {
            chatInterface.toggleMinimize();
        }

        function handleSendChat() {
            chatInterface.handleSend();
        }

        // Utility function to show toast messages
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                document.body.removeChild(toast);
            }, 3000);
        }

        // Global functions for admin panel (simplified)
        window.loadPendingItems = function() {
            document.getElementById('adminContent').innerHTML = '<p>Pending items would be listed here in a full implementation.</p>';
        };

        window.loadClaimVerifications = function() {
            document.getElementById('adminContent').innerHTML = '<p>Claim verifications would be listed here in a full implementation.</p>';
        };

        window.loadUserManagement = function() {
            document.getElementById('adminContent').innerHTML = '<p>User management would be available here in a full implementation.</p>';
        };
    </script>
</body>
</html>
